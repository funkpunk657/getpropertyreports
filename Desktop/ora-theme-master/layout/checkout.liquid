<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="{{ locale }}" dir="{{ direction }}" class="{{ checkout_html_classes }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, user-scalable=0">

    {% include 'scripts-yotpo' %}

    <title>{{ shop.name }} - {{ page_title }}</title>

    {{ content_for_header }}

    {{ checkout_stylesheets }}
    {{ checkout_scripts }}

    <script>{% include 'jquery.js' %}</script>
    <script>{% include 'anime.min.js' %}</script>
    
  </head>
  <body>

    <div class="banner" data-header>
      <div class="wrap">
        {{ content_for_logo }}
      </div>
    </div>

    {{ order_summary_toggle }}

    <div class="content" data-content>
      <div class="wrap">
        <div class="sidebar" role="complementary">
          {% if settings.show_delayed_shipping %}
            <div class="delayed__shipping-wrapper">
              <div class="delayed__shipping">
                <h4>{{ settings.delayed_shipping_message_header }}</h4>
                <p>{{ settings.delayed_shipping_message_text }}</p>
              </div>
            </div>
          {% endif %}
          <div class="sidebar__header">
            {{ content_for_logo }}
          </div>
          <div class="sidebar__content">
            {{ content_for_order_summary }}
            <!-- Typeform: Post-checkout Survey -->
            {% comment %}{% include 'survey_checkout' %}{% endcomment %}
          </div>
        </div>
        <div class="main" role="main">
          <div class="main__header">
            {{ content_for_logo }}
            {{ breadcrumb }}
            {{ alternative_payment_methods }}
          </div>
          <div class="main__content">
            {{ content_for_layout }}
          </div>
          <div class="main__footer">
            {{ content_for_footer }}
          </div>
          <!-- Clickbank: Footer -->
          {% for tag in checkout.order.tags %}
            {% if checkout.order.tags contains "Clickbank" %}
              {% include 'clickbank-footer' %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>

    {{ tracking_code }}
    
  </body>
  <!-- <script>{% include 'jquery.js' %}</script> -->
  <!-- APPLY WHOLESALE DISCOUNT - if customer is tagged with Wholesale and discount is active -->
  {% if settings.apply_wholesale_discount and checkout.customer.tags contains 'Wholesale' %}
  <script>
    $('#checkout_reduction_code').val("{{ settings.wholesale_discount_code }}");
    $('#checkout_reduction_code').parent().next('button').click();
  </script>
  {% endif %}

  <!-- Include custom scripts -->
  <script>{% include 'animations.js' %}</script>
  <script>{% include 'custom.js' %}</script>

  <!-- Additional Customer Information -->
  <script>
    $(document).ready(function() {

      console.log("insert birthday")

      // Insert Birthday + Referrer
      function additionalInfo() {
        $('.section.section--billing-address')
        .after(
          '<div class="section section--additional-information">'+
            '<div class="section__header">'+
              '<h2 class="section__title">A bit about you</h2>'+
              '<p class="section__text">Let us know when your big day is so we can be sure to send you a little something special!</p>'+
            '</div>'+
            '<div class="section__content">'+
              '<div id="birthday" class="fieldset">'+ // Birthday
                '<div class="field field--required field--show-floating-label">'+
                  '<div class="field__input-wrapper">'+
                    '<label class="field__label field__label--visible" for="checkout_birthday">Birthday</label>'+
                    '<input type="date" class="field__input" aria-required="true" name="checkout[birthday]" id="checkout_birthday">'+
                    '<p class="required">Please enter your date of birth</p>'+
                  '</div>'+
                '</div>'+
              '</div>'+
              '<div id="referrer" class="fieldset">'+ // Referrer
                '<div class="field field--required field--show-floating-label">'+
                  '<div class="field__input-wrapper">'+
                    '<label class="field__label field__label--visible" for="checkout_referrer">How did you find out about Ora?</label>'+
                    '<select type="select" class="field__input" id="checkout_referrer" name="referrer">'+
                      '<option value="" disabled selected>Please select an option</option>'+
                      '<option value="Google">Google</option>'+
                      '<option value="Facebook">Facebook</option>'+
                      '<option value="Instagram">Instagram</option>'+
                      '<option value="Pinterest">Pinterest</option>'+
                      '<option value="Podcast">Podcast</option>'+
                      '<option value="Friend / Family">Friend / Family</option>'+
                      '<option value="Vitamin Shoppe">Vitamin Shoppe</option>'+
                      '<option value="Health Practitioner">Health Practitioner</option>'+
                      '<option value="Print (magazines etc.)">Print (magazines etc.)</option>'+
                      '<option value="Shark Tank">Shark Tank</option>'+
                      '<option value="Other">Other</option>'+
                    '</select>'+
                    '<p class="required">Please let us know how you found out about Ora!</p>'+
                  '</div>'+
                  '<div class="field__input-wrapper other">'+
                    '<label class="field__label field__label--visible" for="referred_by_other">Let us know here...</label>'+
                    '<input id="referred_by_other" class="field__input" aria-required="true" name="referrer" type="text" data-option="Other"/>'+
                  '</div>'+
                  '<div class="field__input-wrapper other">'+
                    '<label class="field__label field__label--visible" for="referred_by_podcast">Which Podcast?</label>'+
                    '<input id="referred_by_podcast" class="field__input" aria-required="true" name="referrer" placeholder="Which Podcast?" type="text" data-option="Podcast"/>'+
                  '</div>'+
                  '<div class="field__input-wrapper other">'+
                    '<label class="field__label field__label--visible" for="referred_by_print">Which publication?</label>'+
                    '<input id="referred_by_print" class="field__input" aria-required="true" name="referrer" placeholder="Which publication?" type="text" data-option="Print (magazines etc.)"/>'+
                  '</div>'+
                '</div>'+
              '</div>'+
            '</div>'+
         '</div>'
        )
      }

      additionalInfo();

      // Replace Submit button
      var original_submit_button = $('.step[data-step="payment_method"] .step__footer button[type="submit"]'),
          new_submit_button      = '<button id="export_additional_info" class="btn" style="background-color: {{ settings.accent_color_1 }};"><span class="btn__content">Complete order</span></button>';

      original_submit_button.hide(); // Hide original button
      original_submit_button.after(new_submit_button); // Add new button 

      // Create action to send additional information to Zapier, and then trigger the checkout
      setTimeout(function() {

        /* Show the other text input when ooption selected */
        $('#checkout_referrer').on('change', function() {

          console.log($(this).val());

          val = $(this).val();

          if (val == "Other" || val == "Podcast" || val == "Print (magazines etc.)") {

            // Slide up the other text inputs, and slide down the relevant one
            $(this).parents('.field').find('.other').slideUp();
            $('input[data-option="'+$(this).val()+'"]').parents('.other').slideDown();

          } else {
            $(this).parents('.field').find('.other').slideUp();
          }

        })

         // Create validation handlers
        $('.field--required .field__input').on('mouseleave', function() {

          if ($(this).val() == "" || $(this).val() == null) {
            $(this).parents('.field').addClass('invalid');
          } else {
            $(this).parents('.field').removeClass('invalid');
          }

        })

        $('#export_additional_info').click(function(e) {

          // e.preventDefault();

          /* Get the cart contents */
          var products_added = [];
          $('.product__description__name').each(function() {
            var product = $(this).text(),
                variant = $(this).parent().find('.product__description__variant').text();
            products_added.push(product+" - "+variant);
          })

          var birthday    = $('#checkout_birthday').val(),
              referred_by = $('#checkout_referrer').val();

          /* Get the referred by value */
          if ($('#referred_by_other').val() !== "" && $('#checkout_referrer').val() == "Other") {
            console.log($('#referred_by_other').val());
            var referred_by = "Other: "+$('#referred_by_other').val();
          } else  if ($('#referred_by_podcast').val() !== "" && $('#checkout_referrer').val() == "Podcast") {
            var referred_by = "Podcast: "+$('#referred_by_podcast').val();
          } else if ($('#referred_by_print').val() !== "" && $('#checkout_referrer').val() == "Print (magazines etc.)") {
            var referred_by = "Print: "+$('#referred_by_print').val();
          } else {
            var referred_by = $('#checkout_referrer]').val();
          }

          console.log("{{ customer.id }} - send info to zapier");

          var data = {
            "first_name"            : "{{ checkout.customer.first_name }}",
            "last_name"             : "{{ checkout.customer.last_name }}",
            "email"                 : "{{ checkout.customer.email }}",
            "birthday"              : birthday,
            "referrer"              : referred_by,
            "products_added"        : products_added,
            "value"                 : "{{ checkout.total_price | money_without_currency }}",
            "order_number"          : "{{ checkout.order_name }}",
            "order_id"              : "https://oraorganic.myshopify.com/admin/orders/{{ checkout.order_id }}"
          }

          console.log(data);

          zapierWebhook("https://hooks.zapier.com/hooks/catch/914765/al2n81/", "POST", data, function() {
            console.log("submission success");
          })

        })
      },300)


      $('#referred_by_submit').click(function() {

        /* Get the referred by value */
        if ($('#referred_by_other').val() !== "" && $('input[value="Other"]').is(':checked')) {
          console.log("otherrrrr");
          console.log($('#referred_by_other').val());
          var referred_by = "Other: "+$('#referred_by_other').val();
        } else  if ($('#referred_by_podcast').val() !== "" && $('input[value="Podcast"]').is(':checked')) {
          var referred_by = "Podcast: "+$('#referred_by_podcast').val();
        } else if ($('#referred_by_print').val() !== "" && $('input[value="Print (magazines etc.)"]').is(':checked')) {
          var referred_by = "Print: "+$('#referred_by_print').val();
        } else {
          var referred_by = $('input[name="referred_by"]:checked').val();
        }

        /* Get the cart contents */
        var products_added = [];
        $('.product__description__name').each(function() {
          var product = $(this).text(),
              variant = $(this).parent().find('.product__description__variant').text();
          products_added.push(product+" - "+variant);
        })

        /* Get Survey & Customer Data */
        var survey_contents = {
            "first_name"            : "{{ checkout.customer.first_name }}",
            "last_name"             : "{{ checkout.customer.last_name }}",
            "email"                 : "{{ checkout.customer.email }}",
            "referred_by"           : referred_by,
            "products_added"        : products_added,
            "value"                 : "{{ checkout.total_price | money_without_currency }}",
            "order_number"          : "{{ checkout.order_name }}",
            "order_id"              : "https://oraorganic.myshopify.com/admin/orders/{{ checkout.order_id }}"
          }

        /* Send the data to Zapier webhook (Google Sheets) */
        $.ajax({
          type: "POST",
          url: "https://hooks.zapier.com/hooks/catch/914765/ftyt5k/",
          data: survey_contents,
          success: (function() {
            console.log("submission success");
            /* Retrieve the results of the survey and run the spinner until they've come back */
            $('.form__questions, .form__actions').slideUp();
            $('.form__thanks').slideDown();

          })(),
          dataType: JSON
        });
      })
    })
  </script>

  <!-- APPLY SPECIAL DEAL DISCOUNT - if sidebar deal is active -->
  {% if settings.deal_sidebar_auto %}
    <!-- Check cart items, if sale item is in the cart then auto-apply the discount -->
    {% assign sale_product_in_cart = false %}
    {% for item in checkout.line_items %}
      {% if item.product.tags contains "on_sale=true" %}
        {% assign sale_product_in_cart = true %}
      {% endif %}
    {% endfor %}
    {% if sale_product_in_cart %}
      <style>
        .applied-reduction-code .applied-reduction-code__information {
          display: none !important;
          color: transparent;
        }
        .applied-reduction-code {
          color: transparent;
        }
        .applied-reduction-code:before {
          content: "{{ settings.deal_sidebar_code_viewable }}";
          font-weight: bold;
          color: {{ settings.copy_color }};
        }
      </style>
      {% if checkout.line_items.size == 1 %}
      <script>
        $('#checkout_reduction_code').css('color', 'white').val("{{ settings.deal_sidebar_code_1 }}"); // Apply the discount
        $('#checkout_reduction_code').parent().next('button').click();
        setTimeout(function() { $('.applied-reduction-code__information').remove() }, 3000);
      </script>
      {% else %}
      <script>
        $('#checkout_reduction_code').css('color', 'white').val("{{ settings.deal_sidebar_code_2 }}"); // Apply the discount, hide the entry
        $('#checkout_reduction_code').parent().next('button').click();
        setTimeout(function() { $('.applied-reduction-code__information').remove() }, 3000);
      </script>
      {% endif %}
    {% endif %}
  {% endif %}
  <!-- MAKE PHONE NUMBER REQUIRED FOR INTERNATIONAL ORDERS -->
  <script>
    $(document).ready(function() {
      
      function checkShippingCountry() {
        var shipping_country = $('#checkout_shipping_address_country').val();
      
        if (shipping_country !== "United States" && $('#checkout_shipping_address_phone').val() < 1) { 
          $('#checkout_shipping_address_phone') // Make the field required
            .prop('required', true)
            .attr('placeholder', 'Phone (required)')
            .parents('.field')
              .removeClass('field--optional')
              .addClass('field--required');
          $('.step__footer button').addClass('inactive'); // Make the next button inactive
        } else {
          $('#checkout_shipping_address_phone')
            .prop('required', false)
            .attr('placeholder', 'Phone (optional)')
              .addClass('field--optional')
              .removeClass('field--required');
          $('.step__footer button').removeClass('inactive'); // Make the next button active
        }
      }

      // checkShippingCountry(); // Check shipping country on page load

      $('#checkout_shipping_address_country, #checkout_shipping_address_phone').on('change paste keyup', function() {
        checkShippingCountry(); // Check shipping country when shipping country changes
      })

    })
  </script>
  <!-- STYLE FOR INACTIVE BUTTON -->
  <style>
    button.inactive {
      background-color: #e8e8e8 !important;
      pointer-events: none !important;
    }
  </style>


</html>
